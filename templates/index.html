<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Power Electronics Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto auto;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }
        .grid-item { padding: 10px; border: 1px solid #ddd; }
        label { display: block; margin: 5px 0; }
        input, select { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; }
        pre { background-color: #f4f4f4; padding: 10px; white-space: pre-wrap; }
        #mosfetPlot, #thermalPlot, #eonPlot, #eoffPlot { width: 100%; height: 400px; }
        #modelViewer { width: 100%; height: 400px; border: 1px solid #ddd; }
        .page-title { text-align: center; margin-bottom: 20px; }
        .created-by { text-align: center; font-size: 0.9em; color: #666; }
        .no-data-message { text-align: center; color: #888; font-style: italic; }
        .package-info { font-size: 0.9em; color: #444; margin-bottom: 10px; }
        .input-section { display: flex; justify-content: space-between; }
        .input-form { flex: 1; margin-right: 20px; }
        .model-viewer { flex: 1; }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <!-- Page Title and Created By -->
    <div class="page-title">
        <h1>MOSFET ANN Model Library</h1>
        <p class="created-by">Created by Fulong Li</p>
    </div>

    <div class="grid-container">
        <!-- (1,1) Input Form and Model Viewer -->
        <div class="grid-item input-section" style="grid-column: 1 / span 2; grid-row: 1;">
            <div class="input-form">
                <h2>Input</h2>
                <div class="package-info">
                    <p>Price: {{ package_info.price }}</p>
                </div>
                <form method="POST">
                    <label for="model_file">Select Model File:</label>
                    <select name="model_file" id="model_file">
                        {% for model_file in model_files %}
                        <option value="{{ model_file }}" {% if model_file == selected_model %}selected{% endif %}>
                            {{ model_file }}
                        </option>
                        {% endfor %}
                    </select>

                    <label for="choice">Select Calculation:</label>
                    <select name="choice" id="choice" onchange="toggleInputs()" required>
                        <option value="1">Switching Loss</option>
                        <option value="2">Conduction Loss (MOSFET)</option>
                        <option value="3">Conduction Loss (Body Diode)</option>
                        <option value="4">Thermal Impedance</option>
                        <option value="5">Total Loss</option>
                    </select>

                    <label for="duty_cycle">Duty Cycle (0 to 1):</label>
                    <input type="number" step="0.01" name="duty_cycle" value="0.5" min="0" max="1" required>

                    <label for="f_sw">Switching Frequency (kHz):</label>
                    <input type="number" step="0.1" name="f_sw" value="20" required>

                    <div id="common_inputs" class="input-group">
                        <label for="ids">Current (Ids, A):</label>
                        <input type="number" step="0.1" name="ids" id="ids">
                        <label for="temp">Temperature (°C):</label>
                        <input type="number" step="0.1" name="temp" id="temp">
                    </div>

                    <div id="switching_inputs" class="input-group">
                        <label for="vds">Voltage (Vds, V):</label>
                        <input type="number" step="0.1" name="vds" id="vds">
                        <label for="rgon">Rgon (Ω, default 2.5):</label>
                        <input type="number" step="0.1" name="rgon" value="2.5">
                        <label for="rgoff">Rgoff (Ω, default 2.5):</label>
                        <input type="number" step="0.1" name="rgoff" value="2.5">
                    </div>

                    <div id="thermal_input" class="input-group">
                        <label for="time">Time (s):</label>
                        <input type="number" step="0.001" name="time" id="time">
                    </div>

                    <button type="submit">Calculate</button>
                </form>
            </div>
            <div class="model-viewer">
                <h2>Package Model (TO-247-3)</h2>
                <div id="modelViewer"></div>
            </div>
        </div>

        <!-- (2,1) Result -->
        <div class="grid-item" style="grid-column: 1 / span 2; grid-row: 2;">
            <h2>Result</h2>
            {% if result %}
            <pre>{{ result }}</pre>
            {% else %}
            <p>Enter values and click Calculate to see results.</p>
            {% endif %}
        </div>

        <!-- (3,1) MOSFET Conduction Loss 3D Plot (ANN Surface + JSON Scatter) -->
        <div class="grid-item" style="grid-column: 1 / span 2; grid-row: 3;">
            <h2>MOSFET Conduction Loss (ANN vs Measured Data)</h2>
            <div id="mosfetPlot"></div>
        </div>

        <!-- (4,1) Turn-On Loss Plot -->
        <div class="grid-item" style="grid-column: 1; grid-row: 4;">
            <h2>Turn-On Loss (ANN{% if not switching_loss_data.has_measured_data %} - No Measured Data{% endif %})</h2>
            <div id="eonPlot"></div>
        </div>

        <!-- (4,2) Turn-Off Loss Plot -->
        <div class="grid-item" style="grid-column: 2; grid-row: 4;">
            <h2>Turn-Off Loss (ANN{% if not switching_loss_data.has_measured_data %} - No Measured Data{% endif %})</h2>
            <div id="eoffPlot"></div>
        </div>

        <!-- (5,1) Thermal Impedance Comparison Plot -->
        <div class="grid-item" style="grid-column: 1 / span 2; grid-row: 5;">
            <h2>Thermal Impedance (ANN vs Measured Data)</h2>
            <div id="thermalPlot"></div>
        </div>
    </div>

    <script>
        function toggleInputs() {
            const choice = document.getElementById('choice').value;
            const commonInputs = document.getElementById('common_inputs');
            const switchingInputs = document.getElementById('switching_inputs');
            const thermalInput = document.getElementById('thermal_input');

            commonInputs.style.display = 'none';
            switchingInputs.style.display = 'none';
            thermalInput.style.display = 'none';

            if (choice == '1' || choice == '5') {
                commonInputs.style.display = 'block';
                switchingInputs.style.display = 'block';
            } else if (choice == '2' || choice == '3') {
                commonInputs.style.display = 'block';
            } else if (choice == '4') {
                thermalInput.style.display = 'block';
            }
        }
        toggleInputs();

        // Initialize 3D Model Viewer
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff); // 白色背景
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true }); // 启用透明背景支持
        renderer.setSize(400, 400);
        renderer.shadowMap.enabled = true; // 启用阴影
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // 软阴影
        document.getElementById('modelViewer').appendChild(renderer.domElement);

        // Add lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); // 白色环境光
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2); // 主光源
        directionalLight.position.set(10, 10, 10).normalize();
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 50;
        scene.add(directionalLight);
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.7); // 辅助光
        directionalLight2.position.set(-10, -10, -10).normalize();
        scene.add(directionalLight2);

        // Load GLTF/GLB model
        const loader = new THREE.GLTFLoader();
        const modelPath = "/static/models/TO247-3.glb";
        console.log('Attempted model path:', modelPath);
        loader.load(
            modelPath,
            function (gltf) {
                const model = gltf.scene;
                scene.add(model);

                // 启用阴影
                model.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                // Auto-center and scale the model
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 5 / maxDim; // 减少缩放比例
                model.scale.set(scale, scale, scale);
                model.position.sub(center.multiplyScalar(scale));

                // Adjust camera position
                camera.position.set(15, 15, 30); // 增加距离
                camera.lookAt(0, 0, 0);
            },
            undefined,
            function (error) {
                console.error('Error loading GLTF model:', error);
                console.log('Attempted model path:', modelPath);
                document.getElementById('modelViewer').innerHTML = '<p>Error loading 3D model. Check the file path and console.</p>';
            }
        );

        // Initialize OrbitControls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 1;
        controls.maxDistance = 100;

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', function () {
            const width = document.getElementById('modelViewer').clientWidth;
            const height = document.getElementById('modelViewer').clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // MOSFET Conduction Loss Plot (ANN Surface + JSON Scatter)
        const mosfetData = {{ mosfet_3d_data | tojson }};
        const mosfetPlotData = [];

        if (mosfetData.ann && mosfetData.ann.currents.length > 0 && mosfetData.ann.temps.length > 0) {
            const surfacecolor = [];
            for (let i = 0; i < mosfetData.ann.temps.length; i++) {
                const row = [];
                for (let j = 0; j < mosfetData.ann.currents.length; j++) {
                    row.push(mosfetData.ann.temps[i]);
                }
                surfacecolor.push(row);
            }

            mosfetPlotData.push({
                x: mosfetData.ann.currents,
                y: mosfetData.ann.temps,
                z: mosfetData.ann.vds,
                type: 'surface',
                name: 'ANN Model',
                showlegend: true,
                surfacecolor: surfacecolor,
                colorscale: [
                    [0, '#00008B'],
                    [0.25, '#0000FF'],
                    [0.5, '#00CED1'],
                    [0.75, '#FFA500'],
                    [1, '#FF0000']
                ],
                opacity: 0.9,
                showscale: true,
                colorbar: {
                    title: 'Temperature (°C)',
                    titleside: 'right',
                    tickvals: [-25, 0, 50, 100, 150, 175],
                    ticktext: ['-25', '0', '50', '100', '150', '175']
                }
            });
        }

        if (mosfetData.json && mosfetData.json.ids.length > 0) {
            mosfetPlotData.push({
                x: mosfetData.json.ids,
                y: mosfetData.json.temps,
                z: mosfetData.json.vds,
                type: 'scatter3d',
                mode: 'markers',
                name: 'Measured Data',
                showlegend: true,
                marker: {
                    size: 5,
                    color: '#ff7f0e',
                    opacity: 0.8
                }
            });
        }

        const mosfetLayout = {
            scene: {
                xaxis: { title: 'Current (A)' },
                yaxis: { title: 'Temperature (°C)' },
                zaxis: { title: 'Vds (V)' },
                camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
            },
            margin: { l: 0, r: 20, b: 0, t: 20 },
            height: 400,
            legend: {
                x: 1,
                y: 1,
                xanchor: 'right',
                yanchor: 'top',
                traceorder: 'normal',
                font: { size: 12 },
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1
            }
        };

        Plotly.newPlot('mosfetPlot', mosfetPlotData, mosfetLayout);

        // Thermal Impedance Comparison Plot (log scales)
        const annThermalData = {{ ann_thermal_data | tojson }};
        const fileThermalData = {{ file_thermal_data | tojson }};
        const thermalPlotData = [
            {
                x: annThermalData.times,
                y: annThermalData.zth,
                type: 'scatter',
                mode: 'lines',
                name: 'ANN Model',
                line: { color: '#1f77b4', width: 2 },
                showlegend: true
            },
            {
                x: fileThermalData.times,
                y: fileThermalData.zth,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Measured Data',
                line: { color: '#ff7f0e', width: 2 },
                marker: { size: 5 },
                showlegend: true
            }
        ];

        const thermalLayout = {
            xaxis: {
                title: 'Time (s)',
                type: 'log',
                autorange: true
            },
            yaxis: {
                title: 'Zth_jc (K/W)',
                type: 'log',
                autorange: true
            },
            margin: { l: 50, r: 20, b: 50, t: 20 },
            height: 400,
            legend: {
                x: 1,
                y: 1,
                xanchor: 'right',
                yanchor: 'top',
                font: { size: 12 },
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1
            }
        };

        Plotly.newPlot('thermalPlot', thermalPlotData, thermalLayout);

        // Turn-On Loss Plot (Eon)
        const switchingLossData = {{ switching_loss_data | tojson }};
        const eonPlotData = [];

        // Plot ANN Model (surface)
        if (switchingLossData.ann && switchingLossData.ann.ids.length > 0 && switchingLossData.ann.vds.length > 0) {
            eonPlotData.push({
                x: switchingLossData.ann.ids,
                y: switchingLossData.ann.vds,
                z: switchingLossData.ann.eon,
                type: 'surface',
                name: 'ANN Model',
                showlegend: true,
                colorscale: [
                    [0, '#00008B'], // Deep Blue
                    [0.25, '#0000FF'], // Blue
                    [0.5, '#00CED1'], // Cyan
                    [0.75, '#FFA500'], // Orange
                    [1, '#FF0000'] // Red
                ],
                opacity: 0.9,
                showscale: true,
                colorbar: {
                    title: 'Turn-On Loss (µJ)',
                    titleside: 'right'
                }
            });
        }

        // Plot Measured Data (scatter) if available
        if (switchingLossData.has_measured_data && switchingLossData.measured.eon.ids.length > 0) {
            eonPlotData.push({
                x: switchingLossData.measured.eon.ids,
                y: switchingLossData.measured.eon.vds,
                z: switchingLossData.measured.eon.eon,
                type: 'scatter3d',
                mode: 'markers',
                name: 'Measured Data',
                showlegend: true,
                marker: {
                    size: 5,
                    color: '#ff7f0e',
                    opacity: 0.8
                }
            });
        }

        const eonLayout = {
            scene: {
                xaxis: { title: 'Ids (A)' },
                yaxis: { title: 'Vds (V)' },
                zaxis: { title: 'Turn-On Loss (µJ)' },
                camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
            },
            margin: { l: 0, r: 20, b: 0, t: 20 },
            height: 400,
            legend: {
                x: 1,
                y: 1,
                xanchor: 'right',
                yanchor: 'top',
                traceorder: 'normal',
                font: { size: 12 },
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1
            }
        };

        Plotly.newPlot('eonPlot', eonPlotData, eonLayout);

        // Turn-Off Loss Plot (Eoff)
        const eoffPlotData = [];

        // Plot ANN Model (surface)
        if (switchingLossData.ann && switchingLossData.ann.ids.length > 0 && switchingLossData.ann.vds.length > 0) {
            eoffPlotData.push({
                x: switchingLossData.ann.ids,
                y: switchingLossData.ann.vds,
                z: switchingLossData.ann.eoff,
                type: 'surface',
                name: 'ANN Model',
                showlegend: true,
                colorscale: [
                    [0, '#00008B'], // Deep Blue
                    [0.25, '#0000FF'], // Blue
                    [0.5, '#00CED1'], // Cyan
                    [0.75, '#FFA500'], // Orange
                    [1, '#FF0000'] // Red
                ],
                opacity: 0.9,
                showscale: true,
                colorbar: {
                    title: 'Turn-Off Loss (µJ)',
                    titleside: 'right'
                }
            });
        }

        // Plot Measured Data (scatter) if available
        if (switchingLossData.has_measured_data && switchingLossData.measured.eoff.ids.length > 0) {
            eoffPlotData.push({
                x: switchingLossData.measured.eoff.ids,
                y: switchingLossData.measured.eoff.vds,
                z: switchingLossData.measured.eoff.eoff,
                type: 'scatter3d',
                mode: 'markers',
                name: 'Measured Data',
                showlegend: true,
                marker: {
                    size: 5,
                    color: '#ff7f0e',
                    opacity: 0.8
                }
            });
        }

        const eoffLayout = {
            scene: {
                xaxis: { title: 'Ids (A)' },
                yaxis: { title: 'Vds (V)' },
                zaxis: { title: 'Turn-Off Loss (µJ)' },
                camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
            },
            margin: { l: 0, r: 20, b: 0, t: 20 },
            height: 400,
            legend: {
                x: 1,
                y: 1,
                xanchor: 'right',
                yanchor: 'top',
                traceorder: 'normal',
                font: { size: 12 },
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1
            }
        };

        Plotly.newPlot('eoffPlot', eoffPlotData, eoffLayout);
    </script>
</body>
</html>